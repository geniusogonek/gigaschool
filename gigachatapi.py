import os

from datetime import date
from gigachat import GigaChat
from gigachat.models import Chat, Messages, MessagesRole

from dotenv import load_dotenv

from db.database import get_all_user_subjects

load_dotenv()

API_KEY = os.getenv("API_KEY")


payload_base = Chat(
    messages=[
        Messages(
            role=MessagesRole.SYSTEM,
            content="действуй железно и четко, как очень умный алгоритм, а не нейросеть"
        )
    ],
)

weekdays = ["mon", "tue", "wed", "thu", "fri", "sat", "sun"]


async def get_answer(session, text: str, tg_id) -> str:
    with GigaChat(credentials=API_KEY, verify_ssl_certs=False) as giga:
        payload = payload_base.copy()
        payload.messages.append(Messages(
            role=MessagesRole.USER,
            content=f"""Проанализируй запрос пользователя и верни ТОЛЬКО JSON без дополнительного текста.

ЗАПРОС ПОЛЬЗОВАТЕЛЯ: {text}
ТЕКУЩАЯ ДАТА: {date.today().strftime("%d/%m/%Y")}, {weekdays[date.today().weekday()]}

ДОСТУПНЫЕ ПРЕДМЕТЫ ПОЛЬЗОВАТЕЛЯ:
{", ".join((i['name'] for i in await get_all_user_subjects(session, tg_id)))}

ПРАВИЛА КЛАССИФИКАЦИИ:

1. ТИП: РАСПИСАНИЕ НА ДЕНЬ
   Когда: пользователь запрашивает все уроки на определенный день
   Примеры: "расписание на завтра", "что у меня в понедельник", "покажи уроки на 28 ноября"
   Формат ответа:
   {{"type": "schedule", "date": "дата в формате ДД/ММ/ГГГГ"}}

2. ТИП: КОНКРЕТНЫЙ УРОК
   Когда: пользователь спрашивает про один конкретный урок
   Примеры: "какой 3 урок завтра", "что на 5 паре сегодня", "следующий урок"
   Формат ответа:
   {{"type": "lesson", "date": "дата в формате ДД/ММ/ГГГГ", "lesson_number": номер_урока_или_None}}
   
   ВАЖНО: lesson_number = None (именно None, не null), если:
   - пользователь написал "следующий урок" и дата = сегодняшняя дата
   - номер урока явно не указан, но подразумевается текущий/следующий

3. ТИП: ДОБАВЛЕНИЕ ДОМАШНЕГО ЗАДАНИЯ
   Когда: пользователь добавляет домашнее задание по предмету на определенную дату
   Примеры: 
   - "На завтра по математике упражнение 45 и 46" → subject_name: "алгебра" (если алгебра в списке выше)
   - "Домашка на понедельник: биология параграф 12" → subject_name: "биолог" (если биолог в списке выше)
   - "На 28 ноября по физике решить задачи 1-10" → subject_name: "физика"
   Формат ответа:
   {{"type": "add_homework", "date": "дата в формате ДД/ММ/ГГГГ", "subject_name": "точное название из списка выше", "text": "текст домашнего задания"}}
   
   КРИТИЧЕСКИ ВАЖНО для subject_name:
   - Используй ТОЛЬКО названия предметов из списка "ДОСТУПНЫЕ ПРЕДМЕТЫ ПОЛЬЗОВАТЕЛЯ"
   - Сопоставляй упомянутый предмет с ближайшим из списка (математика→алгебра, матем→алгебра, мат→алгебра)
   - Учитывай сокращения: "матем"/"мат"→"алгебра", "рус"→"рус.яз", "англ"→"англ.яз", "физ-ра"→"физ-ра", "геом"→"геомет"
   - Если предмет из запроса совпадает частично - выбери наиболее похожий
   - Если предмет невозможно сопоставить со списком - используй type: "undetected"
   
   Для текста задания:
   - В поле text помести ТОЛЬКО описание задания
   - Убери из text дату, предмет и слова "на", "по", "домашка"

4. ТИП: ПРОСМОТР ДОМАШНЕГО ЗАДАНИЯ
   Когда: пользователь запрашивает домашнее задание на определенную дату
   Примеры:
   - "какое дз на завтра"
   - "домашка на понедельник"
   - "покажи домашнее задание на 28 ноября"
   - "что задали на завтра"
   Формат ответа:
   {{"type": "get_homework", "date": "дата в формате ДД/ММ/ГГГГ"}}
   
   ВАЖНО:
   - Этот тип используется ТОЛЬКО для просмотра/получения домашки
   - Если пользователь добавляет/записывает дз - используй тип "add_homework"

5. ТИП: ИЗМЕНЕНИЕ РАСПИСАНИЯ
   Когда: пользователь сообщает об изменениях в расписании (замена урока или отмена)
   Примеры:
   - "завтра вместо химии математика" → замена химии на математику
   - "завтра математики не будет" → отмена математики
   - "в понедельник физику заменили на географию" → замена физики на географию
   - "28 ноября биологии не будет" → отмена биологии
   Формат ответа:
   {{"type": "edit_schedule", "changes": [{{"date": "дата в формате ДД/ММ/ГГГГ", "subject_from": "название предмета из списка", "subject_to": "название предмета из списка или ---"}}]}}
   
   КРИТИЧЕСКИ ВАЖНО:
   - Используй ТОЛЬКО предметы из списка "ДОСТУПНЫЕ ПРЕДМЕТЫ ПОЛЬЗОВАТЕЛЯ"
   - subject_from - предмет, который заменяют/отменяют
   - subject_to - предмет, на который заменяют (или "---" если урок отменяется)
   - Если урок отменяется ("не будет"), ставь subject_to: "---"
   - Если урок заменяется, оба предмета должны быть из списка
   - Массив changes может содержать несколько изменений, если их указано в запросе
   - Если предметы не найдены в списке - используй type: "undetected"

6. ТИП: УСТАНОВКА НАПОМИНАНИЯ
   Когда: пользователь просит напомнить о чем-то в определенное время
   Примеры:
   - "напомни мне завтра в 15:00 сделать домашку"
   - "поставь напоминание на понедельник в 8:30 проснуться"
   - "напомни в 14:00 сегодня позвонить маме"
   - "уведоми меня 28 ноября в 10:00 о встрече"
   Формат ответа:
   {{"type": "notify", "datetime": "дата и время в формате ДД/ММ/ГГГГ ЧЧ:ММ", "text": "текст напоминания"}}
   
   ВАЖНО для напоминаний:
   - datetime должен содержать ОБЯЗАТЕЛЬНО и дату и время в формате "ДД/ММ/ГГГГ ЧЧ:ММ"
   - Если время не указано явно - используй разумное время по умолчанию (утро 09:00, день 14:00, вечер 18:00)
   - В поле text помести то, о чем нужно напомнить (без даты и времени)
   - Примеры datetime: "28/11/2025 15:00", "01/12/2025 08:30"

7. ТИП: ЗАПРОС НЕ РАСПОЗНАН
   Когда: запрос не относится к расписанию, урокам, домашнему заданию, напоминаниям ИЛИ предмет не найден в списке
   Примеры: "привет", "как дела", "сколько будет 2+2", "по непонятному предмету задание"
   Формат ответа:
   {{"type": "undetected"}}

ПРАВИЛА ОБРАБОТКИ ДАТ:
- "сегодня" = текущая дата
- "завтра" = текущая дата + 1 день
- "послезавтра" = текущая дата + 2 дня
- "понедельник", "вторник", "среду" и т.д. = ближайший такой день недели от текущей даты
- Конкретная дата "28 ноября" = преобразуй в формат ДД/ММ/ГГГГ текущего или следующего года

ПРАВИЛА ОБРАБОТКИ ВРЕМЕНИ:
- Если указано точное время "в 15:00", "в 8:30" - используй его
- "утром" = 09:00, "днем" = 14:00, "вечером" = 18:00, "ночью" = 22:00
- Если время не указано для напоминания - используй 09:00 по умолчанию

СТРОГИЕ ТРЕБОВАНИЯ:
- Возвращай ТОЛЬКО валидный JSON, без пояснений, без markdown блоков
- Все значения полей на РУССКОМ языке
- Если не уверен в классификации → используй тип "undetected"
- В поле date ВСЕГДА формат ДД/ММ/ГГГГ
- В поле datetime ВСЕГДА формат ДД/ММ/ГГГГ ЧЧ:ММ
- В поле lesson_number пиши None (не "None", не null)
- subject_name/subject_from/subject_to должны ТОЧНО совпадать с предметами из списка "ДОСТУПНЫЕ ПРЕДМЕТЫ"
- Если предмет не найден в списке - вернуть {{"type": "undetected"}}
- Различай "add_homework" (добавление дз) и "get_homework" (просмотр дз)
- Для изменений расписания используй "---" для отмены урока
"""


))
        response = giga.chat(payload)
        payload.messages.append(response.choices[0].message)
        return response.choices[0].message.content 
